<style>
  .custom-vtt-player {
    border: 1px solid red;
    margin-top: 5rem;
  }
  .custom-vtt-player .controls {
    display: flex;
    justify-content: center;
    flex-direction: row;
    background: #f2f2f2;
    padding: 12px 24px;
  }

  .custom-vtt-player .controls .buttons {
    display: flex;
    gap: 5px;
    margin: 0 auto;
  }
  .custom-vtt-player .controls .playpause {
    border: none;
    cursor: pointer;
    border-radius: 50%;
    padding: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .custom-vtt-player .controls .playpause:hover,
  .custom-vtt-player .controls .playpause:active {
    background: #e1e1e1;
  }
  .custom-vtt-player .highlight {
    background-color: yellow;
  }

  .custom-vtt-player .seek-bar[data-moving="true"] {
  }
  .custom-vtt-player .rwd,
  .custom-vtt-player .fwd {
    width: 3rem;
  }
</style>
<div class="custom-vtt-player">
  <div class="controls">
    <div class="buttons">
      <!-- <button class="rwd"><< 3</button> -->
      <button class="playpause" aria-label="Play or pause audio">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="currentColor"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="play-icon"
        >
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="currentColor"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="pause-icon"
          style="display: none"
        >
          <rect x="6" y="4" width="4" height="16"></rect>
          <rect x="14" y="4" width="4" height="16"></rect>
        </svg>
      </button>
      <div
        class="timelapse"
        style="display: flex; align-items: center; min-width: 6rem"
      >
        <span class="time" style="margin-right: 4px">00:00</span>
        <span class="time-end">/ 00:00</span>
      </div>
      <!-- <button class="stop">Stop</button> -->
      <!-- <button class="fwd">3 >></button> -->
    </div>
    <div style="width: 100%; display: flex; align-items: center">
      <input type="range" class="seek-bar" min="0" style="width: 100%" />
    </div>
  </div>
  <audio class="audio-player" crossorigin="anonymous">
    <source src="assets/audio/shelley-frankenstein-sample.mp3" />
    <track
      default
      class="transcript"
      kind="captions"
      src="assets/audio/vtt/shelley-frankenstein-sample-transcript.vtt"
    />
  </audio>
  <div class="transcript-cues"></div>
</div>
<script>
  (function () {
    class CustomAudioPlayer {
      defaultOptions = {
        elements: {
          audioPlayer: ".custom-vtt-player .audio-player",
        },
        isClickable: {
          transcriptLine: false,
        },
      };

      constructor(options) {
        this.options = {
          elements: Object.assign(
            {},
            this.defaultOptions.elements,
            options.elements,
          ),
          isClickable: Object.assign(
            {},
            this.defaultOptions.isClickable,
            options.isClickable,
          ),
        };

        console.log(this.options);
        this.state = {
          isPlaying:
            !!!document.querySelector(this.options.elements.audioPlayer)
              .paused || false,
          interaction: {
            isSeekBarMoving: false,
          },
        };
        console.log(this.state);
      }

      debounce = (func, wait) => {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      };

      convertToPlayerTime = (time) => {
        const mins = Math.floor(time / 60).toString();

        const secs = Math.floor(time % 60)
          .toString()
          .padStart(2, "0");

        return `${mins}:${secs}`;
      };

      init = () => {
        console.log("hit");

        console.log(this.options);
        const audio = document.querySelector(this.options.elements.audioPlayer);

        audio.removeAttribute("controls");

        const playPauseBtn = document.querySelector(
          ".custom-vtt-player .playpause",
        );
        const stopBtn = document.querySelector(".custom-vtt-player .stop");
        const rwdBtn = document.querySelector(".custom-vtt-player .rwd");
        const fwdBtn = document.querySelector(".custom-vtt-player .fwd");
        const timeLabel = document.querySelector(".custom-vtt-player .time");

        playPauseBtn.onclick = () => {
          if (!this.state.isPlaying) {
            this.state.isPlaying = true;
            audio.play();
            playPauseBtn.querySelector(".pause-icon").style.display = "block";
            playPauseBtn.querySelector(".play-icon").style.display = "none";
            return null;
          }

          this.state.isPlaying = false;
          audio.pause();
          playPauseBtn.querySelector(".play-icon").style.display = "block";
          playPauseBtn.querySelector(".pause-icon").style.display = "none";
        };

        if (stopBtn) {
          stopBtn.onclick = () => {
            audio.pause();
            audio.currentTime = 0;
            playPauseBtn.querySelector(".play-icon").style.display = "block";
            playPauseBtn.querySelector(".pause-icon").style.display = "none";
          };
        }

        if (rwdBtn) {
          rwdBtn.onclick = () => {
            audio.currentTime -= 3;
          };
        }

        if (fwdBtn) {
          fwdBtn.onclick = () => {
            audio.currentTime += 3;
            if (audio.currentTime >= audio.duration || audio.paused) {
              audio.pause();
              audio.currentTime = 0;
              playPauseBtn.querySelector(".play-icon").style.display = "block";
              playPauseBtn.querySelector(".pause-icon").style.display = "none";
            }
          };
        }

        const seekBar = document.querySelector(".custom-vtt-player .seek-bar");

        audio.addEventListener("loadedmetadata", () => {
          seekBar.max = audio.duration;

          if (seekBar.max) {
            document.querySelector(".custom-vtt-player .time-end").innerText =
              ` / ${this.convertToPlayerTime(seekBar.max)}`;
          }
        });

        seekBar.addEventListener("input", function () {
          const time = (audio.duration / 100) * seekBar.value;
          audio.currentTime = time;
        });

        audio.ontimeupdate = () => {
          if (!seekBar.getAttribute("data-moving")) {
            seekBar.value = audio.currentTime;
          }
          const mediaTime = this.convertToPlayerTime(audio.currentTime);
          timeLabel.textContent = mediaTime;

          const highlightCue = this.debounce(highlightActiveCue, 1000);

          highlightCue();
        };

        seekBar.addEventListener("input", () => {
          audio.currentTime = seekBar.value;

          this.state.interaction.isSeekBarMoving = true;
          seekBar.setAttribute("data-moving", "true");
        });

        seekBar.addEventListener("change", () => {
          audio.currentTime = seekBar.value;

          console.log("test: ", this.convertToPlayerTime(seekBar.max));

          seekBar.removeAttribute("data-moving");
          this.state.interaction.isSeekBarMoving = false;
        });

        const seek = (seconds) => {
          audio.currentTime = seconds;
          audio.play();
        };

        const transcript = audio.querySelector("track.transcript");

        const transcriptCues = document.querySelector(
          ".custom-vtt-player .transcript-cues",
        );

        if (transcript.track.cues.length) {
          for (let i = 0; i < transcript.track.cues.length; i++) {
            const cue = transcript.track.cues[i];

            const p = document.createElement("p");
            p.classList.add("cue");
            p.dataset.startTime = cue.startTime;
            p.dataset.endTime = cue.endTime;
            p.innerText = `[${this.convertToPlayerTime(cue.startTime)} - ${this.convertToPlayerTime(cue.endTime)}]:  ${cue.text}`;

            console.log(this.options);

            if (this.options.isClickable.transcriptLine) {
              p.addEventListener("click", function () {
                seek(cue.startTime);
              });
            }

            transcriptCues.append(p);
          }
        }

        const highlightActiveCue = () => {
          const currentTime = document.querySelector(
            this.options.elements.audioPlayer,
          ).currentTime;

          console.log("current TIme:", currentTime);
          const cues = document.querySelectorAll(".custom-vtt-player .cue");

          cues.forEach((cue) => {
            const startTime = parseFloat(cue.dataset.startTime);
            const endTime = parseFloat(cue.dataset.endTime);

            if (currentTime >= startTime && currentTime <= endTime) {
              cue.classList.add("highlight");
            } else {
              cue.classList.remove("highlight");
            }
          });
        };
      };
    }

    const myPlayer = new CustomAudioPlayer({
      isClickable: {
        transcriptLine: false,
      },
    });

    function onTranscriptLoad() {
      document
        .querySelector(".audio-player track.transcript")
        .addEventListener("load", function () {
          myPlayer.init();
        });
    }

    if (
      document.readyState === "complete" ||
      document.readyState === "interactive"
    ) {
      onTranscriptLoad();
      return null;
    }

    document.addEventListener("DOMContentLoaded", onTranscriptLoad);
  })();
</script>
