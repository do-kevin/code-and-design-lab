<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Astro description" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0"
    />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body style="margin: 0">
    <slot />
  </body>
</html>
<style>
  .infinite-video-scroller img,
  .infinite-video-scroller video {
    width: 100%;
  }
  .infinite-video-scroller .scroll-item {
    max-width: 400px;
    margin-right: 1rem;
  }
</style>
<article class="infinite-video-scroller">
  <div
    class="scroll-container"
    style="
      display: flex;
      overflow-x: scroll;
      padding-bottom: 2rem;
      align-items: flex-start;
    "
  >
    <div class="scroll-item" style="background-color: yellow">
      <picture>
        <source
          srcset="/public/assets/images/banner/Frame_1_D.jpg"
          media="(min-width: 768px)"
          sizes="(min-width: 768px) 50vw, 100vw"
        />
        <img
          src="/public/assets/images/banner/Frame_1_M.jpg"
          loading="lazy"
          sizes="100vw"
          alt="Amazing Lip Oil"
        />
      </picture>
    </div>
    <div class="scroll-item" style="background-color: pink">
      <video autoplay muted loop controls>
        <source src="/assets/videos/pixels-video-4-min.mp4" />
      </video>
    </div>
  </div>
</article>
<script>
  console.log("init 0");
  (function () {
    const initScroller = function () {
      const scrollContainer = document.querySelector(".scroll-container");
      let scrollItems = document.querySelectorAll(
        ".infinite-video-scroller .scroll-item",
      );

      scrollItems = Array.from(scrollItems);

      console.log("scrollItems: ", scrollItems);

      function ensureMediaLoaded() {
        const mediaElements = scrollItems.flatMap((item) =>
          Array.from(item.querySelectorAll("img, video")),
        );

        console.log("mediaElements", mediaElements);

        const mediaPromises = mediaElements.map((media) => {
          if (media.tagName === "VIDEO") {
            return new Promise((resolve) => {
              if (media.readyState >= 3) {
                resolve();
              } else {
                media.addEventListener("loadeddata", resolve, { once: true });
              }
            });
          } else if (media.tagName === "IMG") {
            return new Promise((resolve) => {
              if (media.complete) {
                resolve();
              } else {
                media.addEventListener("load", resolve, { once: true });
              }
            });
          }
          return Promise.resolve();
        });

        return Promise.all(mediaPromises);
      }

      const positions = [];
      const initialPositions = [];

      let totalWidth = 0;

      ensureMediaLoaded().then(() => {
        scrollItems.forEach((item, index) => {
          console.log(item.getBoundingClientRect());
          const itemWidth = item.getBoundingClientRect().width;
          positions[index] = totalWidth;
          initialPositions[index] = totalWidth;
          item.style.transform = `translateX(0px)`;
          totalWidth += itemWidth;
        });

        console.log(positions, totalWidth);

        function doScrolling() {
          scrollItems.forEach((item, index) => {
            // Something wrong with initial positions
            // We should try doing an actual for loop to get the width/position of the next item

            // 1. First, let's make sure the first item moves to the end of the scrollContainer elem
            // 2. Now do the same for the next scrollItem
            const itemPosition = positions[index];

            positions[index] -= 2;

            // console.log("hit: ", positions);

            if (
              positions[index] &&
              positions[index] <= -item.getBoundingClientRect().width
            ) {
              positions[index] = item.getBoundingClientRect().width;

              //   const nextPosition =
              //     scrollItems[index + 1].getBoundingClientRect().width;

              const nextPosition =
                scrollContainer.getBoundingClientRect().width;

              item.style.transform = `translateX(${nextPosition}px)`;

              return null;
            }

            // console.log(scrollItems[scrollItems.length - 1]);

            // if (
            //   positions[scrollItems.length - 1] <=
            //   -scrollItems[scrollItems.length - 1].getBoundingClientRect().width
            // ) {
            //   const nextPosition = scrollItems[0].getBoundingClientRect().width;

            //   scrollItems[scrollItems.length - 1].style.transform =
            //     `translateX(${nextPosition}px)`;
            // }

            item.style.transform = `translateX(${itemPosition}px)`;
          });
          requestAnimationFrame(doScrolling);
        }

        doScrolling();

        console.log(scrollContainer.getBoundingClientRect().width);
      });
    };

    if (
      document.readyState === "loading" ||
      document.readyState === "complete"
    ) {
      initScroller();
      return null;
    }

    document.addEventListener("DOMContentLoaded", function () {
      initScroller();
    });
  })();
</script>
